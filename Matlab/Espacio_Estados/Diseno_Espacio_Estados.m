%% Ejercicio - Sistemas de Seguimiento

clear all, close all, clc

% Constantes
m = 1.79;      g= 9.77412;
Ix = 0.03;     Iy = 0.03;
Iz = 0.04;     T = 0.01;

A = [0 0 0 0  0 0 1 0 0 0 0 0 ;
     0 0 0 0  0 0 0 1 0 0 0 0 ;
     0 0 0 0  0 0 0 0 1 0 0 0 ;
     0 0 0 0  0 0 0 0 0 1 0 0 ;
     0 0 0 0  0 0 0 0 0 0 1 0 ;
     0 0 0 0  0 0 0 0 0 0 0 1 ;
     0 0 0 0 -g 0 0 0 0 0 0 0 ;
     0 0 0 g  0 0 0 0 0 0 0 0 ;
     0 0 0 0  0 0 0 0 0 0 0 0 ;
     0 0 0 0  0 0 0 0 0 0 0 0 ;
     0 0 0 0  0 0 0 0 0 0 0 0 ;
     0 0 0 0  0 0 0 0 0 0 0 0]

B = [0 0 0 0;
     0 0 0 0;
     0 0 0 0;
     0 0 0 0;
     0 0 0 0;
     0 0 0 0;
     0 0 0 0;
     0 0 0 0;
     -1/m 0 0 0;
     0 1/Ix 0 0;
     0 0 -1/Iy 0;
     0 0 0 -1/Iz]

C = [1 0 0 0 0 0 0 0 0 0 0 0 ;
     0 1 0 0 0 0 0 0 0 0 0 0 ;
     0 0 1 0 0 0 0 0 0 0 0 0 ;
     0 0 0 0 0 1 0 0 0 0 0 0 ]

Aux1 = zeros(4,4);

Aux2 = zeros(12,4);
% Verificando controlabilidad:

M = [B A*B A^2*B A^3*B A^4*B A^5*B A^6*B A^7*B A^8*B A^9*B A^10*B A^11*B ]
rank(M)

Mcc = [B     A;
       Aux1 -C]
rank(Mcc)
det(Mcc)
% Definición del sistema ampliado:

Abar = [ A  Aux2;
        -C  Aux1]

Bbar = [B;
        Aux1]

%% 
% *Polos Deseados*

Pd = -[0.2 0.5 1 1.1 1.2 1.3 1.4 1.5 1.6 1.7 1.8 1.9 1.10 1.11 1.12 1.13]
% Definiendo la matriz de espacios nulos de los eigenvalores:

S1 = [Abar - Pd(1)*eye(16) Bbar];
S2 = [Abar - Pd(2)*eye(16) Bbar];
S3 = [Abar - Pd(3)*eye(16) Bbar];
S4 = [Abar - Pd(4)*eye(16) Bbar];
S5 = [Abar - Pd(5)*eye(16) Bbar];
S6 = [Abar - Pd(6)*eye(16) Bbar];
S7 = [Abar - Pd(7)*eye(16) Bbar];
S8 = [Abar - Pd(8)*eye(16) Bbar];
S9 = [Abar - Pd(9)*eye(16) Bbar];
S10 = [Abar - Pd(10)*eye(16) Bbar];
S11 = [Abar - Pd(11)*eye(16) Bbar];
S12 = [Abar - Pd(12)*eye(16) Bbar];
S13 = [Abar - Pd(13)*eye(16) Bbar];
S14 = [Abar - Pd(14)*eye(16) Bbar];
S15 = [Abar - Pd(15)*eye(16) Bbar];
S16 = [Abar - Pd(16)*eye(16) Bbar];
% rref(): forma escalonada de fila reducida

a = rref(S1);
b = rref(S2);
c = rref(S3);
d = rref(S4);
e = rref(S5);
f = rref(S6);
g = rref(S7);
h = rref(S8);
i = rref(S9);
j = rref(S10);
k = rref(S11);
l = rref(S12);
m = rref(S13);
n = rref(S14);
o = rref(S15);
p = rref(S16);
% Insertando ceros para que la matriz quede cuadrada

a1 = [a ;
      zeros(4,20)]

b1 = [b ;
      zeros(4,20)];

c1 = [c ;
      zeros(4,20)];

d1 = [d ;
      zeros(4,20)];

e1 = [e ;
      zeros(4,20)];

f1 = [f ;
      zeros(4,20)];

g1 = [g ;
      zeros(4,20)];

h1 = [h ;
      zeros(4,20)];

i1 = [i ;
      zeros(4,20)];

j1 = [j ;
      zeros(4,20)];

k1 = [k ;
      zeros(4,20)];

l1 = [l ;
      zeros(4,20)];

m1 = [m ;
      zeros(4,20)];

n1 = [n ;
      zeros(4,20)];

o1 = [o ;
      zeros(4,20)];

p1 = [p ;
      zeros(4,20)];
% Cambiar 0's de la diagonal principal por -1

a1(17,17) = -1;
a1(18,18) = -1;
a1(19,19) = -1;
a1(20,20) = -1;
a1;

b1(17,17) = -1;
b1(18,18) = -1;
b1(19,19) = -1;
b1(20,20) = -1;
b1;

c1(17,17) = -1;
c1(18,18) = -1;
c1(19,19) = -1;
c1(20,20) = -1;
c1;

d1(17,17) = -1;
d1(18,18) = -1;
d1(19,19) = -1;
d1(20,20) = -1;
d1;

e1(17,17) = -1;
e1(18,18) = -1;
e1(19,19) = -1;
e1(20,20) = -1;
e1;

f1(17,17) = -1;
f1(18,18) = -1;
f1(19,19) = -1;
f1(20,20) = -1;
f1;

g1(17,17) = -1;
g1(18,18) = -1;
g1(19,19) = -1;
g1(20,20) = -1;
g1;

h1(17,17) = -1;
h1(18,18) = -1;
h1(19,19) = -1;
h1(20,20) = -1;
h1;

i1(17,17) = -1;
i1(18,18) = -1;
i1(19,19) = -1;
i1(20,20) = -1;
i1;

j1(17,17) = -1;
j1(18,18) = -1;
j1(19,19) = -1;
j1(20,20) = -1;
j1;

k1(17,17) = -1;
k1(18,18) = -1;
k1(19,19) = -1;
k1(20,20) = -1;
k1;

l1(17,17) = -1;
l1(18,18) = -1;
l1(19,19) = -1;
l1(20,20) = -1;
l1;

m1(17,17) = -1;
m1(18,18) = -1;
m1(19,19) = -1;
m1(20,20) = -1;
m1;

n1(17,17) = -1;
n1(18,18) = -1;
n1(19,19) = -1;
n1(20,20) = -1;
n1;

o1(17,17) = -1;
o1(18,18) = -1;
o1(19,19) = -1;
o1(20,20) = -1;
o1;

p1(17,17) = -1;
p1(18,18) = -1;
p1(19,19) = -1;
p1(20,20) = -1;
p1;
% Construyendo las matrices Q y V

V = zeros(16,16);
Q = zeros(4,16);

V(:,1) = a1(1:16, 20)/1000*-8;
V(:,2) = b1(1:16, 20)/-50;
V(:,3) = c1(1:16, 20)/-25;
V(:,4) = d1(1:16, 17)/0.41971*100;
V(:,5) = e1(1:16, 17)/0.323297*100;
V(:,6) = f1(1:16, 17)/0.25428*100;
V(:,7) = g1(1:16, 18)/1.70068;
V(:,8) = h1(1:16, 18)/1.48148;
V(:,9) = i1(1:16, 18)/1.30208;
V(:,10) = j1(1:16, 18)/1.1534;
V(:,11) = k1(1:16, 18)/1.02881;
V(:,12) = l1(1:16, 19)/9.2336;
V(:,13) = m1(1:16, 19)/27.5482;
V(:,14) = n1(1:16, 19)/27.0541;
V(:,15) = o1(1:16, 19)/26.5731;
V(:,16) = p1(1:16, 19)/26.1049;
det(V)
%%
Q(:,1) = a1(17:20, 20)/1000*-8;
Q(:,2) = b1(17:20, 20)/-50;
Q(:,3) = c1(17:20, 20)/-25;
Q(:,4) = d1(17:20, 17)/0.41971*100;
Q(:,5) = e1(17:20, 17)/0.323297*100;
Q(:,6) = f1(17:20, 17)/0.25428*100;
Q(:,7) = g1(17:20, 18)/1.70068;
Q(:,8) = h1(17:20, 18)/1.48148;
Q(:,9) = i1(17:20, 18)/1.30208;
Q(:,10) = j1(17:20, 18)/1.1534;
Q(:,11) = k1(17:20, 18)/1.02881;
Q(:,12) = l1(17:20, 19)/9.2336;
Q(:,13) = m1(17:20, 19)/27.5482;
Q(:,14) = n1(17:20, 19)/27.0541;
Q(:,15) = o1(17:20, 19)/26.5731;
Q(:,16) = p1(17:20, 19)/26.1049;

% Q(:,1) = a1(17:20, 20);
% Q(:,2) = b1(17:20, 20);
% Q(:,3) = c1(17:20, 20);
% Q(:,4) = d1(17:20, 20);
% Q(:,5) = e1(17:20, 20);
% Q(:,6) = f1(17:20, 20);
% Q(:,7) = g1(17:20, 20);
% Q(:,8) = h1(17:20, 20);
% Q(:,9) = i1(17:20, 20);
% Q(:,10) = j1(17:20, 20);
% Q(:,11) = k1(17:20, 20);
% Q(:,12) = l1(17:20, 20);
% Q(:,13) = m1(17:20, 20);
% Q(:,14) = n1(17:20, 20);
% Q(:,15) = o1(17:20, 20);
% Q(:,16) = p1(17:20, 20);
Q
% Calcular la matriz de realimentación

Kbar = Q/V
%Kbar = Q*inv(V)
% Matrices de lazo cerrado

Acl = [Abar + Bbar*Kbar]
eig(Acl)

Comprobacion = [-8 0 0 12 0;
                 0 0 1 0 0;
                 0 13 -12 0 60;
                 -1 0 0 0 0;
                 0 -1 -1 0 0]
eig(Comprobacion)
%% 
% 

Bcl = [0 0;
       0 0;
       0 0;
       1 0;
       0 -2];

Ccl = [1 0 0 0 0;
       0 1 1 0 0];

Dcl = [0 0;
       0 0];

[tfn, tfd] = ss2tf(Acl,Bcl,Ccl,Dcl,1)
%[tfn, tfd] = ss2tf(Acl,Bcl,Ccl,Dcl,2)

[yt, xt] = step(Acl,Bcl,Ccl,Dcl,1);
% [yt, xt] = step(Acl,Bcl,Ccl,Dcl,2);


num1 = tfn(1,:);
num2 = tfn(2,:);
den = tfd;
t = 0:.1:5;

step(num1,den)
%print;

step(num2,den)
%print;
diary off